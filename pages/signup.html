<!DOCTYPE html>
<html class="">

<head>
    <title>Sign up</title>
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://unpkg.com/node-forge@0.7.0/dist/forge.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <link rel="stylesheet" href="./styleSheet/signup">
    <link rel="stylesheet" href="./styleSheet/core">
    <link rel="stylesheet" href="./styleSheet/page-transitions">
    <link rel="icon" type="image/x-icon" href="./img/favicon/ico" />
    <script src="./auth"></script>
</head>



<body>
    
    <div class="signup-form animate__animated animate__slideInRight">
        <div>
            <img src="./img/logocircle/png" class="img-responsive"
                style="height: auto; width: 33%; margin-left: 33%; padding-top: 20px;">
        </div>
        <div class="">
            <h2 style="text-align: center; padding-top: 10px;">Get Started Today!</h2>
        </div>
        <div>
            <form>
                <section>
                    <div class="input-area">
                        <img src="./img/user-icon/svg" class="icon">
                        <input class="input-field" type="text" placeholder="Full Name" id="name">
                    </div>
                    <div class="input-area">
                        <img src="./img/email-icon/svg" class="icon">
                        <input class="input-field" type="email" placeholder="Email" id="email">
                    </div>
                    <div class="input-area">
                        <img src="./img/phone-icon/svg" class="icon">
                        <input class="input-field" type="tel" placeholder="Phone Number" id="phone">
                    </div>
                    <div class="input-area">
                        <img src="./img/password-icon/svg" class="icon">
                        <input class="input-field" type="password" placeholder="Password" id="password">
                    </div>
                    <p style="font-size: 12px; margin-left: 20%;" id="passwordCheck">Minimum 8 Characters</p>
                    <div class="input-area">
                        <img src="./img/password-icon/svg" class="icon">
                        <input class="input-field" type="password" placeholder="Confirm Password" id="confirmPassword">
                    </div>
                </section>
                <p class="dable-centered">Have an account? Login <a href="./login" id="clicked"> here</a>!</p>
                <p class='error' id="error"></p>
                <section>
                    <label class="form-checkbox" style="align-self: center;">
                        <input type="checkbox" id="checkboxForTerms">
                        <i class="form-icon"></i> I Agree to the <a href="#"> Terms and Conditions</a>
                    </label>
                </section>
                <section style="margin-top: 20px; text-align:center;">
                    <button type="button" class="submitBtn pageTransition" id="submitBtn" onclick="makeNewAcount()">Sign
                        up</button>
                </section>

            </form>
        </div>
    </div>
    <script>
        if (Cookies.get('AuthKey') == null) {
            var newAuth = fetch('/auth', {
                method: 'get',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8',
                },
            })
                .then(function (response) {
                    console.log(response)
                    return response.json();
                })
                .then(function (auth) {
                    console.log(auth.AuthKey)
                    Cookies.set('AuthKey', auth.AuthKey, { path: 'http://localhost:3000/', secure: true, sameSite: 'strict' })
                })
                .catch(function (error) {
                    console.error("Error:", error);
                });

        }
        document.getElementById("password").oninput = function () {

            var password = document.getElementById("password")
            if (password.value.length >= 8) {
                document.getElementById("passwordCheck").hidden = true
            } else {
                document.getElementById("passwordCheck").hidden = false
            }
        }
        var button = document.getElementById('submitBtn')


        async function makeNewAcount() {
            var name = document.getElementById("name")
            var email = document.getElementById("email")
            var phone = document.getElementById("phone")
            var password = document.getElementById("password")

            var passwordConfirm = document.getElementById("confirmPassword")
            var err = document.getElementById('error')
            if (document.getElementById('checkboxForTerms').checked == true) {
                err.innerText = ""
                if (name.value != "" && name.value.indexOf(" ") > -1) {
                    err.innerText = ""
                    if (email.value != "" && email.value.indexOf("@") > -1) {
                        err.innerText = ''
                        if (phone.value != "" && phone.value.toString().length == 10) {
                            err.innerText = ''
                            if (password.value != "" && password.value == passwordConfirm.value) {
                                err.innerText = ''
                                dataToSend = { "name": name.value, "email": email.value, "phone": phone.value.toString(), "password": forge.util.encode64(password.value) }
                                var res = await fetch("/new-user", {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json;charset=utf-8',
                                        'key': auth
                                    },
                                    body: JSON.stringify(dataToSend)
                                })
                                
                                if(res.status == 455){
                                    err.innerText="Email already used"
                                }
                            } else {
                                err.innerText = "Passwords must match"
                            }
                        } else {
                            err.innerText = "You must use a valid phone number"
                        }
                    } else {
                        err.innerText = "You must use a valid email"
                    }
                } else {
                    err.innerText = "You must use your full name"
                }
            } else {
                err.innerText = "You must Accept the Terms and Services"
            }
        }
    </script>
</body>

</html>